@model PortalDMPlace.Models.Noticia
@using PortalDMPlace.Models
@inject PortalDMPlace.Models.DataContext _context

@{
    ViewData["Title"] = "Editar Crônica";
    Layout = "_LayoutAdmin";
    
    // Busca campanhas dinamicamente do banco
    var campanhas = _context.Campanhas.ToList();
}

<div class="container py-4">
    <h2 class="mb-4 text-warning text-center">✏️ Editar Registro da Crônica</h2>

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger border-danger bg-danger bg-opacity-10 text-danger fw-bold">
            <i class="bi bi-exclamation-octagon-fill me-2"></i> @(ViewBag.Error ?? TempData["Error"])
        </div>
    }

    <form asp-controller="Noticia" asp-action="Editar" method="post" enctype="multipart/form-data" class="bg-dark bg-opacity-75 p-4 rounded-4 border border-warning shadow-lg">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="ImagemUrl" /> <div class="row">
            <div class="col-md-8 border-end border-secondary">
                <div class="mb-3">
                    <label asp-for="Titulo" class="form-label fw-bold text-warning">Título</label>
                    <input asp-for="Titulo" class="form-control bg-dark text-white border-secondary" required />
                    <span asp-validation-for="Titulo" class="text-danger small"></span>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <label asp-for="Conteudo" class="form-label fw-bold text-warning mb-0">Conteúdo (HTML)</label>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="previewHtml()">
                            <i class="bi bi-eye"></i> Ver Prévia
                        </button>
                    </div>
                    <textarea asp-for="Conteudo"
                              class="form-control bg-dark text-light border-secondary font-monospace"
                              rows="18"></textarea>
                    <span asp-validation-for="Conteudo" class="text-danger small"></span>
                </div>

                <div id="previewArea" class="border border-info mt-3 p-4 rounded-3 bg-white text-dark shadow-sm" style="display:none; max-height: 500px; overflow-y: auto;">
                    <div class="d-flex justify-content-between border-bottom mb-3 pb-2">
                        <h5 class="text-info mb-0">Prévia do Conteúdo:</h5>
                        <button type="button" class="btn-close" onclick="document.getElementById('previewArea').style.display='none'"></button>
                    </div>
                    <div id="previewContent"></div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label asp-for="CampanhaId" class="form-label fw-bold text-warning">Campanha</label>
                    <select asp-for="CampanhaId" class="form-select bg-dark text-white border-secondary" required>
                        @foreach (var camp in campanhas)
                        {
                            <option value="@camp.Id">@camp.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label asp-for="Categoria" class="form-label fw-bold text-warning">Categoria</label>
                    <select asp-for="Categoria" class="form-select bg-dark text-white border-secondary">
                        @foreach (var cat in (List<string>)ViewBag.Categorias)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label asp-for="Autor" class="form-label fw-bold text-warning">Autor</label>
                    <input asp-for="Autor" class="form-control bg-dark text-white border-secondary" readonly />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-warning">Trocar Imagem de Capa</label>
                    <input type="file" name="ImagemFile" class="form-control bg-dark text-white border-secondary" accept="image/*" />
                    
                    @if (!string.IsNullOrEmpty(Model.ImagemUrl))
                    {
                        <div class="mt-3 p-2 border border-secondary rounded bg-black bg-opacity-25">
                            <p class="small text-muted mb-2">Imagem Atual:</p>
                            <img src="@Model.ImagemUrl" alt="Capa atual" class="img-fluid rounded border border-warning shadow-sm" />
                        </div>
                    }
                    else
                    {
                        <div class="mt-3 p-2 border border-secondary rounded bg-black bg-opacity-25">
                            <p class="small text-muted mb-2">Imagem Atual:</p>
                            <img src="../../../img/default.jpg" alt="Capa atual" class="img-fluid rounded border border-warning shadow-sm" />
                        </div>
                    }
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-warning">Data Original</label>
                    <input type="text" class="form-control bg-dark text-muted border-secondary" value="@Model.DataPublicacao.ToString("dd/MM/yyyy HH:mm")" readonly />
                </div>
            </div>
        </div>

        <div class="text-end mt-4 border-top border-secondary pt-3">
            <a asp-action="Index" class="btn btn-outline-secondary px-4 me-2">Cancelar</a>
            <button type="submit" class="btn btn-warning px-5 fw-bold text-dark shadow">
                <i class="bi bi-save"></i> Salvar Alterações
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        function previewHtml() {
            const content = document.getElementById("Conteudo").value;
            const preview = document.getElementById("previewContent");
            const area = document.getElementById("previewArea");
            preview.innerHTML = content;
            area.style.display = "block";
            area.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}